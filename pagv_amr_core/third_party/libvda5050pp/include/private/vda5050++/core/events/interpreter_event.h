//  Copyright Open Logistics Foundation
//
//  Licensed under the Open Logistics Foundation License 1.3.
//  For details on the licensing terms, see the LICENSE file.
//  SPDX-License-Identifier: OLFL-1.3
//

#ifndef VDA5050_2B_2B_CORE_EVENTS_INTERPRETER_EVENT_H_
#define VDA5050_2B_2B_CORE_EVENTS_INTERPRETER_EVENT_H_

#include <vda5050/InstantActions.h>
#include <vda5050/Order.h>

#include <memory>
#include <string>
#include <vector>

#include "vda5050++/core/state/graph.h"
#include "vda5050++/events/event_type.h"

namespace vda5050pp::core::events {

///
///\brief The identifier type for InterpreterEvents
///
enum class InterpreterEventType {
  k_yield_navigation_step,
  k_yield_action_group,
  k_yield_instant_action_group,
  k_yield_graph_extension,
  k_yield_graph_replacement,
  k_yield_new_action,
  k_yield_clear_actions,
  k_done,
  k_order_control,
};

///
///\brief The InterpreterEvent type is for events, that are generated by the interpreter.
/// These events appear in order, in which they shall be processed by the scheduler.
///
struct InterpreterEvent : public vda5050pp::events::Event<InterpreterEventType> {};

///
///\brief The interpreter yields this when a new navigation step was interpreted.
///
struct YieldNavigationStepEvent
    : public vda5050pp::events::EventId<InterpreterEvent,
                                        InterpreterEventType::k_yield_navigation_step> {
  ///\brief the goal node of the navigation step
  std::shared_ptr<const vda5050::Node> goal_node;
  ///\brief the edge, that shall be used to reach the goal node
  std::shared_ptr<const vda5050::Edge> via_edge;
  ///\brief if this is true, the AGV is required to stop at the goal node
  bool has_stop_at_goal_hint = false;
};

///
///\brief The interpreter yields this, when a new action group was interpreted.
/// An Action group is a group of actions, which can be executed in parallel.
///
struct YieldActionGroupEvent
    : public vda5050pp::events::EventId<InterpreterEvent,
                                        InterpreterEventType::k_yield_action_group> {
  ///\brief the actions, that shall be executed in parallel
  std::vector<std::shared_ptr<const vda5050::Action>> actions;
  ///\brief the sequence id of the node on which this should be executed
  decltype(vda5050::Node::sequenceId) node_seq_id;
  ///\brief the highest blocking type of the actions in the group. NONE < SOFT < HARD
  vda5050::BlockingType blocking_type_ceiling = vda5050::BlockingType::NONE;
};

///
///\brief The interpreter yields this, when a new group of instant actions was interpreted.
/// An Instant Action group is a group of actions, which can be executed in parallel.
/// Depending on the blocking type, the AGV must stop before they can be executed.
///
struct YieldInstantActionGroup
    : public vda5050pp::events::EventId<InterpreterEvent,
                                        InterpreterEventType::k_yield_instant_action_group> {
  ///\brief the instant actions, that shall be executed in parallel
  std::vector<std::shared_ptr<const vda5050::Action>> instant_actions;
  ///\brief the highest blocking type of the instant actions in the group. NONE < SOFT < HARD
  vda5050::BlockingType blocking_type_ceiling = vda5050::BlockingType::NONE;
};

///
///\brief The interpreter yields this, when the graph of the order was extended.
///
struct YieldGraphExtension
    : public vda5050pp::events::EventId<InterpreterEvent,
                                        InterpreterEventType::k_yield_graph_extension> {
  ///\brief the order update id, that was used to extend the graph
  uint32_t order_update_id;
  ///\brief the graph, that extend the current graph of the order
  std::shared_ptr<vda5050pp::core::state::Graph> graph;
};

///
///\brief The interpreter yields this, when the graph of the order was replaced.
/// Only in case of new orders, i.e. orderId != current orderId.
///
struct YieldGraphReplacement
    : public vda5050pp::events::EventId<InterpreterEvent,
                                        InterpreterEventType::k_yield_graph_replacement> {
  ///\brief the order id of the new order
  std::string order_id;
  ///\brief the graph, that replaces the current graph of the order
  std::shared_ptr<vda5050pp::core::state::Graph> graph;
};

///
///\brief The interpreter yields this, when a new action was interpreted.
/// Actions can appear in orders or instant actions.
///
struct YieldNewAction
    : public vda5050pp::events::EventId<InterpreterEvent,
                                        InterpreterEventType::k_yield_new_action> {
  ///\brief the new action
  std::shared_ptr<const vda5050::Action> action;
};

///
///\brief The interpreter yields this, when all known actions should be cleared.
/// This happens, when a new order is received.
///
struct YieldClearActions
    : public vda5050pp::events::EventId<InterpreterEvent,
                                        InterpreterEventType::k_yield_clear_actions> {};

///
///\brief The interpreter yields this, when the interpretation of the order is done.
/// Usually a receiver buffers all events, until this event is received.
/// After this the scheduling of the actions/navigations can begin.
///
struct InterpreterDone
    : public vda5050pp::events::EventId<InterpreterEvent, InterpreterEventType::k_done> {};

///
///\brief The interpreter yields this, when the scheduling of the order should be controlled.
/// This event is used to pause, resume or cancel the scheduling of the order.
///
struct InterpreterOrderControl
    : public vda5050pp::events::EventId<InterpreterEvent, InterpreterEventType::k_order_control> {
  ///\brief the type of control
  enum class Status {
    ///\brief pause the order
    k_pause,
    ///\brief resume the order
    k_resume,
    ///\brief cancel the order
    k_cancel,
  };
  ///\brief the associated instant action that controls the order.
  std::shared_ptr<const vda5050::Action> associated_action;
  ///\brief the type of control
  Status status;
};

}  // namespace vda5050pp::core::events

#endif  // VDA5050_2B_2B_CORE_EVENTS_INTERPRETER_EVENT_H_
