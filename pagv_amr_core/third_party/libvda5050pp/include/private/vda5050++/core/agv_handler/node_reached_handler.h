//  Copyright Open Logistics Foundation
//
//  Licensed under the Open Logistics Foundation License 1.3.
//  For details on the licensing terms, see the LICENSE file.
//  SPDX-License-Identifier: OLFL-1.3
//

#ifndef VDA5050_2B_2B_CORE_AGV_HANDLER_NODE_REACHED_HANDLER_H_
#define VDA5050_2B_2B_CORE_AGV_HANDLER_NODE_REACHED_HANDLER_H_

#include <optional>

#include "vda5050++/config/node_reached_subconfig.h"
#include "vda5050++/core/module.h"
#include "vda5050++/core/navigation_status_manager.h"

namespace vda5050pp::core::agv_handler {

///
///\brief The NodeReachedHandler module is responsible for handling NavigationStatusPosition events
/// generated by the AGV and checks if the AGV has reached the current driving goal.
/// If so, an NavigationStatusNodeReached event is generated.
///
class NodeReachedHandler : public vda5050pp::core::Module {
  ///
  ///\brief Handles a NavigationStatusPosition event.
  ///
  /// If the auto_check_node_reached flag is set, the AGV's position is checked against the current
  /// driving goal. And a NavigationStatusNodeReached event is generated if the AGV has reached the
  /// goal.
  ///
  ///\param evt the event data
  ///
  ///\throws VDA5050PPInvalidEventData when evt is empty
  ///
  void handleNavigationStatusPosition(
      std::shared_ptr<vda5050pp::events::NavigationStatusPosition> evt) const;

  std::optional<vda5050pp::core::ScopedNavigationStatusSubscriber> navigation_status_subscriber_;
  std::shared_ptr<vda5050pp::config::NodeReachedSubConfig> sub_config_;

public:
  ///
  ///\brief Setup all subscribers and get the loaded config from the instance
  ///
  ///\param instance the current library instance
  ///
  void initialize(Instance &instance) override;

  ///
  ///\brief Unsuscribe all subscribers and reset the config
  ///
  ///\param instance the current library instance
  ///
  void deinitialize(Instance &instance) override;

  ///
  ///\brief Get the module's description (possibly deprecated)
  ///
  ///\return std::string_view
  ///
  std::string_view describe() const override;

  ///
  ///\brief Create a new NodeReachedSubConfig instance
  ///
  ///\return std::shared_ptr<config::ModuleSubConfig> the created subconfig
  ///
  std::shared_ptr<config::ModuleSubConfig> generateSubConfig() const override;
};

}  // namespace vda5050pp::core::agv_handler

#endif  // VDA5050_2B_2B_CORE_AGV_HANDLER_NODE_REACHED_HANDLER_H_
